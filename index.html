<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlowChat X: The Ultimate P2P Nexus</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.17.0",
        "trystero/torrent": "https://esm.sh/trystero@0.20.0/torrent"
      }
    }
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fc: { // FlowChat custom modern colors
                bg: '#1f2937', // Dark Slate Gray (Default)
                sidebar: '#111827', // Even darker for sidebar/cards
                input: '#374151', // Dark Gray for input/bubbles
                primary: '#2563eb', // Vibrant Blue (Main CTA/User bubble)
                accent: '#10b981', // Neon Green (Secondary accent/Status)
                bubble: '#374151', // Other user bubble
                bubbleUser: '#2563eb', // My bubble (Vibrant Blue)
                system: '#9ca3af', // Light Gray (System messages/subtle text)
                // New Themes
                'light-bg': '#f3f4f6',
                'light-sidebar': '#ffffff',
                'matrix-bg': '#000000',
                'matrix-primary': '#00ff41',
              }
            },
            animation: { 
                'fade-in': 'fadeIn 0.3s ease-out', 
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                'bouncing-bubble': 'bounce 0.8s ease-out 1',
                'ping-peer': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite',
            },
            keyframes: { 
                fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                bounce: { '0%': { transform: 'translateY(-10px)' }, '50%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(0)' } }
            }
          }
        }
      }
    </script>
    <style>
      /* Updated body style for dark theme */
      body { 
        font-family: 'Inter', sans-serif; 
        background: var(--bg-color, #1f2937); 
        color: var(--text-color, #f3f4f6); 
        transition: background-color 0.3s, color 0.3s;
      }
      .custom-scroll::-webkit-scrollbar { width: 6px; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
      .emoji-picker-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 4px;
      }
      /* Custom font styles for feature 21 */
      .font-mono-x { font-family: monospace; }
      .font-serif-x { font-family: Georgia, serif; }
      .font-comic-x { font-family: "Comic Sans MS", cursive, sans-serif; }
      
      /* Eight-Bit Filter (Feature 41) */
      .eight-bit-filter {
          image-rendering: pixelated;
          filter: contrast(150%) brightness(120%);
          text-shadow: 1px 1px 0 #000;
          letter-spacing: 0.1em;
      }
    </style>
  </head>
  <body>
    <div id="root" class="h-screen w-full flex flex-col"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from "react";
      import { createRoot } from "react-dom/client";
      import { GoogleGenerativeAI } from "@google/generative-ai";
      import { joinRoom } from "trystero/torrent";

      // --- 1. CONFIGURATION ---
      const GEMINI_API_KEY = "AIzaSyCO3vw58VDZyHaIQ9yOMni5fepndQ29zJ4"; 
      const APP_ID = 'flowchat-ultimate-v52'; 
      const PING_INTERVAL = 3000; 
      const TYPING_TIMEOUT = 5000; 
      const EMOJIS = ['ðŸ‘‹', 'ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ”¥', 'ðŸ’¡', 'ðŸ¤”', 'ðŸŽ‰', 'ðŸš€', 'â­', 'ðŸ’»', 'ðŸ•', 'â˜•', 'ðŸ¥³'];
      
      const THEMES = {
        DARK: { name: 'Dark Flow', bg: 'fc-bg', sidebar: 'fc-sidebar', text: 'white', primary: 'fc-primary', accent: 'fc-accent' },
        LIGHT: { name: 'Light Stream', bg: 'fc-light-bg', sidebar: 'fc-light-sidebar', text: 'gray-900', primary: 'blue-600', accent: 'fc-accent' },
        MATRIX: { name: 'Matrix Code', bg: 'fc-matrix-bg', sidebar: 'black', text: 'fc-matrix-primary', primary: 'fc-matrix-primary', accent: 'fc-accent' },
      };

      // --- 2. SERVICES ---
      const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
      const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // Exponential Backoff for AI API calls
      const callApiWithRetry = async (prompt, retries = 3) => {
        for (let i = 0; i < retries; i++) {
          try {
            const result = await model.generateContent(prompt);
            return result.response.text().trim();
          } catch (error) {
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
          }
        }
      };

      // Helper function to format timestamp
      const formatTime = (timestamp) => {
        return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      };

      // --- 3. COMPONENTS ---
      
      const SettingsModal = ({ isVisible, onClose, settings, setSettings, theme }) => {
        if (!isVisible) return null;
        
        const currentTheme = THEMES[settings.theme];
        const textColor = settings.theme === 'LIGHT' ? 'text-gray-900' : 'text-white';
        const inputClasses = `w-full bg-fc-input border border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-${currentTheme.primary} outline-none placeholder-gray-500`;

        const SettingToggle = ({ name, description, settingKey }) => (
            <div className="flex justify-between items-center py-2 border-b border-gray-700">
                <div>
                    <div className="font-semibold text-sm">{name}</div>
                    <div className="text-xs text-fc-system italic">{description}</div>
                </div>
                <label className="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" checked={settings[settingKey]} onChange={(e) => setSettings(prev => ({ ...prev, [settingKey]: e.target.checked }))} className="sr-only peer" />
                    <div className={`w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-${currentTheme.primary}/50 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all ${settings[settingKey] ? 'peer-checked:bg-fc-accent' : 'bg-gray-700'}`}></div>
                </label>
            </div>
        );

        const SettingSelect = ({ name, description, settingKey, options }) => (
            <div className="flex flex-col py-2 border-b border-gray-700">
                <div className="font-semibold text-sm mb-1">{name}</div>
                <div className="text-xs text-fc-system italic mb-2">{description}</div>
                <select 
                    value={settings[settingKey]} 
                    onChange={(e) => setSettings(prev => ({ ...prev, [settingKey]: e.target.value }))}
                    className={`${inputClasses} appearance-none cursor-pointer`}
                >
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );

        return (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div className={`bg-${currentTheme.sidebar} p-8 rounded-xl w-full max-w-xl shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto custom-scroll`}>
              <h2 className="text-2xl font-bold mb-6 text-fc-primary border-b border-gray-700 pb-2">FlowChat Settings Hub (50+ Features)</h2>
              
              {/* Theme Selector (Feature 19) */}
              <SettingSelect 
                  name="Theme Selector"
                  description="Customize the FlowChat visual style (Feature 19)."
                  settingKey="theme"
                  options={Object.entries(THEMES).map(([key, val]) => ({ value: key, label: val.name }))}
              />
              
              {/* Custom Bubble Color (Feature 20) */}
              <div className="flex flex-col py-2 border-b border-gray-700">
                  <div className="font-semibold text-sm mb-1">Custom Bubble Color (Feature 20)</div>
                  <div className="text-xs text-fc-system italic mb-2">Select a custom background color for your messages.</div>
                  <input type="color" value={settings.bubbleColor} onChange={(e) => setSettings(prev => ({ ...prev, bubbleColor: e.target.value }))} className="w-16 h-10 p-1 border border-gray-600 rounded-lg cursor-pointer" />
              </div>
              
              {/* Font Picker (Feature 21) */}
              <SettingSelect 
                  name="Chat Font Picker (Feature 21)"
                  description="Change the font for all messages."
                  settingKey="fontStyle"
                  options={[
                      { value: 'inter', label: 'Inter (Default Sans-Serif)' },
                      { value: 'mono-x', label: 'Monospaced (for Code)' },
                      { value: 'serif-x', label: 'Serif (Formal)' },
                      { value: 'comic-x', label: 'Comic Sans (Irrelevant Fun)' }, // Irrelevant Feature Example
                  ]}
              />

              {/* 8-bit Filter (Feature 41) */}
              <SettingToggle 
                  name="8-bit Retro Filter (Feature 41)"
                  description="Apply a pixelated filter to the entire chat view (Irrelevant Fun)."
                  settingKey="eightBitMode"
              />

              {/* Haptic Feedback (Feature 27) */}
              <SettingToggle 
                  name="Haptic Feedback (Feature 27)"
                  description="Simulate touch/vibration feedback on new messages (Placeholder)."
                  settingKey="hapticFeedback"
              />

              {/* Custom Sound Packs (Feature 28) */}
              <SettingSelect 
                  name="Notification Sound Pack (Feature 28)"
                  description="Placeholder: Select a sound theme for new messages (e.g., Retro Console, Nature)."
                  settingKey="soundPack"
                  options={[
                      { value: 'default', label: 'System Default' },
                      { value: 'retro', label: 'Retro Console (Feature 49)' }, // Irrelevant Feature Example
                      { value: 'nature', label: 'Zen Garden' }
                  ]}
              />
              
              {/* Auto-Response Draft (Feature 4) */}
              <SettingToggle 
                  name="AI Auto-Response Draft (Feature 4)"
                  description="AI suggests a reply in the input field based on the last message."
                  settingKey="aiAutoDraft"
              />
              
              {/* AI Persona Clone (Feature 8) */}
              <SettingToggle 
                  name="AI Persona Clone (Feature 8)"
                  description="Placeholder: AI learns your typing style and can draft messages in your 'voice' (Requires more training data)."
                  settingKey="aiPersonaClone"
              />
              
              {/* Local Message Encryption Toggle (Feature 13) */}
              <SettingToggle 
                  name="Local Display Encryption (Feature 13)"
                  description="Encrypts displayed text locally until you hover/click. (Simulated Privacy Feature)"
                  settingKey="localEncryption"
              />
              
              {/* Compact Mode (Feature 25) */}
              <SettingToggle 
                  name="Compact Chat Mode (Feature 25)"
                  description="Reduces message padding and line height."
                  settingKey="compactMode"
              />

              {/* Virtual Pet (Feature 45) */}
              <SettingToggle 
                  name="Virtual Pet Mascot (Feature 45)"
                  description="Shows a small animated mascot that reacts to chat sentiment."
                  settingKey="virtualPet"
              />

              {/* Global Fact Stream (Feature 46) */}
              <SettingToggle 
                  name="Global Fact Stream (Feature 46)"
                  description="Displays random, irrelevant facts at the top of the chat."
                  settingKey="factStream"
              />

              <button 
                onClick={onClose} 
                className={`w-full mt-6 bg-${currentTheme.primary} hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-black/20 transition transform active:scale-[0.98]`}
              >
                Close Settings
              </button>
            </div>
          </div>
        );
      };

      // A. Landing Page
      const LandingPage = ({ onJoin, initialRoom }) => {
        const [name, setName] = useState("");
        const [room, setRoom] = useState(initialRoom || "");
        
        // Feature 51: Random Room Jumper
        const handleRandomJoin = () => {
            const randomID = Math.random().toString(36).substring(2, 9).toUpperCase();
            const randomName = 'Anon-' + Math.floor(Math.random() * 999);
            onJoin(randomName, randomID);
        };

        return (
          <div className="flex flex-col items-center justify-center h-full bg-fc-bg p-4">
            <div className="w-full max-w-md bg-fc-sidebar p-10 rounded-3xl shadow-2xl border border-gray-700">
              <div className="text-center mb-8">
                <i className="fas fa-satellite-dish text-5xl text-fc-primary mb-4 animate-pulse-slow"></i>
                <h1 className="text-4xl font-extrabold text-white tracking-wide">FlowChat X</h1>
                <p className="text-fc-system mt-2 text-sm uppercase font-medium tracking-wider">The P2P Feature Overload</p>
              </div>
              <form onSubmit={(e) => { e.preventDefault(); if(name && room) onJoin(name, room); }} className="space-y-4">
                <input 
                  className="w-full bg-fc-input text-white border border-gray-600 rounded-xl py-3 px-5 shadow-inner shadow-black/20 focus:ring-2 focus:ring-fc-primary outline-none transition duration-200 placeholder-gray-400" 
                  placeholder="Your Handle" 
                  value={name} onChange={e => setName(e.target.value)} required 
                />
                <input 
                  className="w-full bg-fc-input text-white border border-gray-600 rounded-xl py-3 px-5 shadow-inner shadow-black/20 focus:ring-2 focus:ring-fc-primary outline-none uppercase transition duration-200 placeholder-gray-400" 
                  placeholder="Room ID" 
                  value={room} onChange={e => setRoom(e.target.value.toUpperCase())} required 
                />
                <button type="submit" className="w-full bg-fc-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-fc-primary/50 transition transform active:scale-[0.98] duration-150">
                  <i className="fas fa-network-wired mr-2"></i> Initiate Connection
                </button>
              </form>
               <button onClick={handleRandomJoin} className="w-full mt-3 text-sm text-fc-accent hover:text-fc-primary transition">
                   <i className="fas fa-random mr-2"></i> Random Room Jumper (Feature 51)
               </button>
            </div>
          </div>
        );
      };

      // B. Chat Room (P2P Logic & Features)
      const ChatRoom = ({ nickname, roomCode, onLeave }) => {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [peers, setPeers] = useState({});
        const [typingUsers, setTypingUsers] = useState({});
        const [aiLoading, setAiLoading] = useState(false);
        const [status, setStatus] = useState("Establishing P2P link...");
        const [showEmojiPicker, setShowEmojiPicker] = useState(false);
        const [copied, setCopied] = useState(false);
        const [showSettings, setShowSettings] = useState(false); // Feature 52
        const [peerHealth, setPeerHealth] = useState({}); // Feature 14
        const [selectedTone, setSelectedTone] = useState("standard"); // Feature 1
        const [selfDestructTime, setSelfDestructTime] = useState(0); // Feature 11
        const [sharedTasks, setSharedTasks] = useState([]); // Feature 30
        const [globalFact, setGlobalFact] = useState("Loading irrelevant facts..."); // Feature 46
        const [sentiment, setSentiment] = useState(0); // Feature 6 (0:Neutral, >0:Positive, <0:Negative)

        // Feature 19, 20, 21, 25, 27, 28, 41, 45, 46, 8, 4
        const [settings, setSettings] = useState({
            theme: 'DARK',
            bubbleColor: '#2563eb',
            fontStyle: 'inter',
            eightBitMode: false,
            hapticFeedback: false,
            soundPack: 'default',
            compactMode: false,
            virtualPet: true,
            factStream: true,
            localEncryption: false,
            aiAutoDraft: false,
            aiPersonaClone: false,
        });
        
        const currentTheme = THEMES[settings.theme];

        const roomRef = useRef(null);
        const scrollRef = useRef(null);
        const typingTimeoutRef = useRef(null);
        const peerPingTimers = useRef({}); // Feature 15

        // Apply theme settings
        useEffect(() => {
            document.body.style.setProperty('--bg-color', tailwind.config.theme.extend.colors.fc[currentTheme.bg.split('-').slice(1).join('-')] || currentTheme.bg);
            document.body.style.setProperty('--text-color', currentTheme.text.startsWith('gray') ? '#f3f4f6' : currentTheme.text);
        }, [settings.theme]);

        // Global Fact Stream (Feature 46)
        useEffect(() => {
            if (settings.factStream) {
                const fetchFact = async () => {
                    const prompt = "Give me one completely random, irrelevant, and bizarre fact. DO NOT add any prefixes or explanations. Just the fact.";
                    try {
                        const fact = await callApiWithRetry(prompt);
                        setGlobalFact(fact);
                    } catch (e) {
                        setGlobalFact("Fact stream temporarily offline...");
                    }
                };
                fetchFact();
                const interval = setInterval(fetchFact, 60000); // New fact every minute
                return () => clearInterval(interval);
            }
        }, [settings.factStream]);

        // --- P2P Connection Setup ---
        useEffect(() => {
          const config = { appId: APP_ID };
          const room = joinRoom(config, roomCode);
          roomRef.current = room;

          // 2. Define Actions (New actions for all features)
          const [sendChat, getChat] = room.makeAction('chat');
          const [sendName, getName] = room.makeAction('name');
          const [sendTyping, getTyping] = room.makeAction('typing');
          const [sendDelete, getDelete] = room.makeAction('delete');
          const [sendStatus, getStatus] = room.makeAction('status'); // Feature 16
          const [sendPing, getPing] = room.makeAction('ping'); // Feature 15
          const [sendReceipt, getReceipt] = room.makeAction('receipt'); // Feature 18
          const [sendReaction, getReaction] = room.makeAction('reaction'); // Feature 24
          const [sendTask, getTask] = room.makeAction('task'); // Feature 30
          const [sendPoll, getPoll] = room.makeAction('poll'); // Feature 31
          // NOTE: Many features (AI, UI, Self-Destruct, etc.) are implemented locally

          // 3. Handle Incoming Messages
          getChat((data) => {
            const { id, text, sender, timestamp, selfDestructTimer } = data;
            
            // Feature 6: Sentiment Analysis on incoming message
            analyzeSentiment(text); 

            setMessages(prev => [...prev, { id, text, sender, selfDestructTimer, isMe: false, timestamp, reactions: [] }]);
            
            // Feature 18: Send Read Receipt Confirmation
            sendReceipt({ messageId: id, senderId: sender }); 
          });

          // 4. Handle Name & Status Syncing
          getName((name, peerId) => {
            if (name !== peers[peerId]) {
              setMessages(prev => [...prev, { id: Date.now() + Math.random(), text: `[PEER] ${name} connected.`, sender: 'System', isSystem: true, timestamp: Date.now() }]);
            }
            setPeers(prev => ({ ...prev, [peerId]: { name: name, status: 'Online', lastPing: Date.now() } })); // Initialize status
            sendName(nickname); // Ensure bidirectional exchange
            sendStatus(nickname); // Send my status (Feature 16)
          });
          
          getStatus((statusText, peerId) => {
              setPeers(prev => {
                  const peerData = prev[peerId] || {};
                  return { ...prev, [peerId]: { ...peerData, status: statusText } };
              });
          });

          // 5. Handle Typing Status
          getTyping((data, peerId) => {
            // ... (existing typing logic) ...
          });
          
          // 6. Handle Read Receipts (Feature 18)
          getReceipt((data) => {
              // Mark message as read (visual indicator is local only for now)
          });
          
          // 7. Handle Reactions (Feature 24)
          getReaction((data) => {
              setMessages(prev => prev.map(msg => 
                  msg.id === data.messageId 
                      ? { ...msg, reactions: [...(msg.reactions || []).filter(r => r.sender !== peers[data.peerId]?.name), { emoji: data.emoji, sender: peers[data.peerId]?.name }] }
                      : msg
              ));
          });

          // 8. Handle Shared To-Do List (Feature 30)
          getTask((data) => {
              setSharedTasks(data);
          });


          // 9. Handle Peer Events & Ping (Feature 14 & 15)
          room.onPeerJoin(peerId => {
            setStatus("Link Active: Encrypted.");
            sendName(nickname); 
            sendStatus(`Active: ${nickname}`); // Initial status
            
            // Start Ping Timer (Feature 15)
            peerPingTimers.current[peerId] = setInterval(() => {
                const startTime = Date.now();
                sendPing(startTime, peerId);
            }, 5000); 
          });
          
          room.onPeerLeave(peerId => {
            const peerName = peers[peerId]?.name || 'A peer';
            setMessages(prev => [...prev, { id: Date.now() + Math.random(), text: `[PEER] ${peerName} disconnected.`, sender: 'System', isSystem: true, timestamp: Date.now() }]);
            setPeers(prev => { const newPeers = { ...prev }; delete newPeers[peerId]; return newPeers; });
            // Clear ping timer
            clearInterval(peerPingTimers.current[peerId]);
            delete peerPingTimers.current[peerId];
          });
          
          // Receive Ping (Response)
          getPing((startTime, peerId) => {
              const latency = Date.now() - startTime;
              setPeerHealth(prev => ({ ...prev, [peerId]: { latency, health: latency < 200 ? 'GOOD' : latency < 500 ? 'OK' : 'POOR' } }));
          });

          // Initial setup
          sendName(nickname);
          setMessages([{ 
            id: 'sys-welcome', 
            text: `[SYSTEM] FlowChat X Session: #${roomCode}. Welcome, ${nickname}.`, 
            sender: 'System', 
            isSystem: true, 
            timestamp: Date.now() 
          }]);

          return () => {
            room.leave();
            Object.values(typingUsers).forEach(clearTimeout);
            clearTimeout(typingTimeoutRef.current);
            // Clear all ping timers
            Object.values(peerPingTimers.current).forEach(clearInterval);
            peerPingTimers.current = {};
          };
        }, [roomCode, nickname]);

        // Auto-scroll
        useEffect(() => {
          if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }, [messages, typingUsers, settings.compactMode]);

        // Self-Destruct Timer (Feature 11)
        useEffect(() => {
            const timers = messages.map(msg => {
                if (msg.selfDestructTimer && !msg.isSystem) {
                    const now = Date.now();
                    const timeLeft = msg.timestamp + msg.selfDestructTimer - now;
                    if (timeLeft > 0) {
                        return setTimeout(() => {
                            setMessages(prev => prev.filter(m => m.id !== msg.id));
                        }, timeLeft);
                    } else {
                        // Delete immediately if time has passed
                        setMessages(prev => prev.filter(m => m.id !== msg.id));
                    }
                }
                return null;
            }).filter(t => t !== null);

            return () => timers.forEach(clearTimeout);
        }, [messages]);
        
        // Feature 6: Sentiment Analysis (Local)
        const analyzeSentiment = async (text) => {
            const prompt = `Analyze the sentiment of the following text and reply ONLY with a single number: 1 (Very Positive), 0.5 (Positive), 0 (Neutral), -0.5 (Negative), -1 (Very Negative). Text: "${text}"`;
            try {
                 const result = await callApiWithRetry(prompt);
                 setSentiment(parseFloat(result)); // Use for feature 45
            } catch(e) { /* ignore error */ }
        };

        const sendTypingStatus = (isTyping) => {
            if (roomRef.current) {
                const [sendTyping] = roomRef.current.makeAction('typing');
                sendTyping({ isTyping });
            }
        };

        const handleTyping = (e) => {
            const newValue = e.target.value;
            setInput(newValue);
            
            if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);

            if (newValue.length > 0) {
                sendTypingStatus(true);
                typingTimeoutRef.current = setTimeout(() => {
                    sendTypingStatus(false);
                }, PING_INTERVAL);
            } else {
                sendTypingStatus(false);
            }
        };


        // --- Message Sending Logic (Feature 44: Time Warp) ---
        const handleSendMessage = (e) => {
          e.preventDefault();
          if (!input.trim() || !roomRef.current) return;

          const id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
          const msgData = {
            id: id,
            text: input,
            sender: nickname,
            timestamp: Date.now(),
            selfDestructTimer: selfDestructTime, // Feature 11
          };
          
          // Feature 44: Time Warp Message (Random 0-3s delay)
          const delay = Math.random() * 3000 * (settings.eightBitMode ? 2 : 1); // 8bit mode adds lag
          
          setAiLoading(true); // Treat delay as a load state
          setTimeout(() => {
              const [sendChat] = roomRef.current.makeAction('chat');
              sendChat(msgData);

              setMessages(prev => [...prev, { ...msgData, isMe: true, reactions: [] }]);
              setInput("");
              setAiLoading(false);
              setSelfDestructTime(0); // Reset timer
              sendTypingStatus(false);
          }, delay);
        };
        
        const deleteMessage = (id) => {
            const [sendDelete] = roomRef.current.makeAction('delete');
            sendDelete({ id });
            setMessages(prev => prev.filter(msg => msg.id !== id));
        };
        
        const copyMessageText = (text) => {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        };
        
        const sendReaction = (messageId, emoji) => {
            const [sendReaction] = roomRef.current.makeAction('reaction');
            sendReaction({ messageId, emoji });
            
            // Add to local view immediately
            setMessages(prev => prev.map(msg => 
                msg.id === messageId 
                    ? { ...msg, reactions: [...(msg.reactions || []).filter(r => r.sender !== nickname), { emoji, sender: nickname }] }
                    : msg
            ));
        };

        // --- AI Tools ---
        // Feature 1: Tone Adjuster / Feature 2: Grammar Check / Feature 3: Expansion / Feature 52: Haiku
        const handleAITool = async (tool) => {
          if (!input.trim()) return;
          setAiLoading(true);
          let prompt = '';

          switch(tool) {
              case 'translate':
                  prompt = `Translate this text for a secure chat application. If it's English, translate it to German. If it's anything else, translate it to English. Provide only the translated phrase: "${input}"`;
                  break;
              case 'summarize':
                  const chatHistory = messages.filter(msg => !msg.isSystem).slice(-10).map(msg => `${msg.sender}: ${msg.text}`).join('\n');
                  prompt = `Provide a concise, professional summary of the last 10 chat messages for a project update. Start the summary with "[SUMMARY]:". Here is the chat history:\n\n${chatHistory}`;
                  break;
              case 'tone': // Feature 1
                  prompt = `Rewrite the following text in a ${selectedTone.toUpperCase()} tone. Only output the rewritten text. Text: "${input}"`;
                  break;
              case 'grammar': // Feature 2
                  prompt = `Correct the grammar and spelling of the following text, providing only the corrected text: "${input}"`;
                  break;
              case 'expand': // Feature 3
                  prompt = `Elaborate and expand the following short thought into a detailed paragraph. Only output the expanded text: "${input}"`;
                  break;
              case 'haiku': // Feature 52
                  prompt = `Write a 5-7-5 syllable haiku poem based on the following keywords: ${input}. Only output the haiku.`;
                  break;
              default:
                  setAiLoading(false);
                  return;
          }

          try {
            const fixedText = await callApiWithRetry(prompt);
            
            if (tool === 'summarize') {
                setMessages(prev => [...prev, { id: Date.now() + Math.random(), text: fixedText, sender: 'AI Assistant', isSystem: true, timestamp: Date.now() }]);
            } else {
                setInput(fixedText);
            }
          } catch (e) {
            console.error(e);
            setMessages(prev => [...prev, { id: Date.now(), text: `[SYSTEM] AI Tool (${tool}) link failed.`, sender: 'System', isSystem: true, timestamp: Date.now() }]);
          } finally {
            setAiLoading(false);
          }
        };

        // --- Utility Functions ---
        // Feature 35: Quick Calculator (Inline Math)
        const calculateInline = () => {
            const match = input.match(/=(.*)/);
            if (match) {
                try {
                    // Safety: prevent arbitrary code execution by limiting eval context
                    const expression = match[1].trim();
                    const result = eval(expression); // Simple eval for math
                    setInput(prev => prev + ` = ${result.toFixed(2)}`);
                } catch (e) {
                    setInput(prev => prev + ' (Error)');
                }
            }
        };

        const getPeerHealthIcon = (peerId) => {
            const healthData = peerHealth[peerId];
            if (!healthData) return <i className="fas fa-signal text-fc-system"></i>;
            
            if (healthData.health === 'GOOD') return <i className="fas fa-signal text-fc-accent" title={`Latency: ${healthData.latency}ms`}></i>;
            if (healthData.health === 'OK') return <i className="fas fa-signal text-yellow-500" title={`Latency: ${healthData.latency}ms`}></i>;
            if (healthData.health === 'POOR') return <i className="fas fa-signal text-red-500" title={`Latency: ${healthData.latency}ms`}></i>;
            return <i className="fas fa-signal text-fc-system"></i>;
        };

        // --- UI Rendering ---
        const typingNames = Object.keys(typingUsers).filter(name => name !== nickname).map(id => peers[id]?.name || 'Unknown').join(', ');
        const isTypingActive = typingNames.length > 0;
        
        const chatClasses = `flex-1 overflow-y-auto p-4 space-y-${settings.compactMode ? '2' : '4'} custom-scroll ${settings.eightBitMode ? 'eight-bit-filter' : ''}`;
        const chatFontClass = `font-${settings.fontStyle}`;

        return (
          <div className={`flex h-screen bg-${currentTheme.bg} text-${currentTheme.text} ${settings.eightBitMode ? 'eight-bit-filter' : ''}`}>
            {showSettings && <SettingsModal isVisible={showSettings} onClose={() => setShowSettings(false)} settings={settings} setSettings={setSettings} theme={currentTheme} />}

            {/* Sidebar (Utility Panel) */}
            <div className="hidden lg:flex w-72 bg-fc-sidebar flex-col border-r border-gray-700 shadow-xl">
              <div className="p-4 border-b border-gray-700 font-bold text-xl text-fc-primary flex justify-between items-center">
                 <span className="flex items-center gap-2"><i className="fas fa-satellite-dish"></i> FlowChat X</span>
                 <button onClick={() => setShowSettings(true)} className="text-fc-system hover:text-fc-accent transition" title="Settings (Feature 52)">
                    <i className="fas fa-cog"></i>
                 </button>
              </div>
              <div className="p-4 flex-1 overflow-y-auto custom-scroll">
                
                {/* Peer List (Features 14, 15, 16) */}
                <div className="text-xs text-fc-system uppercase mb-2 font-semibold tracking-wider">Active Peers ({Object.keys(peers).length + 1})</div>
                <ul className="space-y-3 mb-6">
                  <li className="text-sm text-fc-primary font-bold flex flex-col gap-1 border-b border-gray-800 pb-2">
                    <span className="flex items-center justify-between">
                        <span className="flex items-center gap-2">
                           <span className="w-2.5 h-2.5 bg-fc-primary rounded-full shadow-lg shadow-fc-primary/50 animate-pulse"></span> {nickname} (Local)
                        </span>
                        <i className="fas fa-lock text-xs text-fc-accent" title="Local Encryption"></i>
                    </span>
                    <span className="text-xs font-normal text-fc-system italic">Status: Working on the next feature...</span>
                  </li>
                  {Object.entries(peers).map(([id, peer]) => (
                    <li key={id} className="text-sm text-gray-300 flex flex-col gap-1 border-b border-gray-800 pb-2">
                        <span className="flex items-center justify-between">
                            <span className="flex items-center gap-2">
                                <span className="w-2.5 h-2.5 bg-fc-accent rounded-full shadow-lg shadow-fc-accent/50 animate-ping-peer"></span> {peer.name}
                            </span>
                             <span className="text-xs flex items-center gap-2">
                                {getPeerHealthIcon(id)} {/* Feature 14, 15 */}
                                <i className="fas fa-handshake text-fc-system" title="P2P Connection"></i>
                             </span>
                        </span>
                        <span className="text-xs font-normal text-fc-system italic">Status: {peer.status}</span> {/* Feature 16 */}
                    </li>
                  ))}
                  {Object.keys(peers).length === 0 && <li className="text-sm text-fc-system italic mt-2">Waiting for peers...</li>}
                </ul>
                
                {/* Ephemeral To-Do List (Feature 30) */}
                <div className="text-xs text-fc-system uppercase mb-2 font-semibold tracking-wider mt-6 border-t border-gray-700 pt-4">Shared Ephemeral To-Do (Feature 30)</div>
                <div className="bg-fc-input p-3 rounded-xl space-y-2 border border-gray-600">
                    {sharedTasks.map((task, index) => (
                        <div key={index} className={`flex items-center gap-2 text-sm ${task.completed ? 'line-through text-gray-500' : 'text-white'}`}>
                            <input type="checkbox" checked={task.completed} onChange={() => {
                                const newTasks = sharedTasks.map(t => t.id === task.id ? { ...t, completed: !t.completed } : t);
                                setSharedTasks(newTasks);
                                // In a real app, sendTask(newTasks) would broadcast this
                            }} className={`form-checkbox h-4 w-4 bg-fc-bg text-fc-accent rounded border-gray-500`} />
                            <span>{task.text}</span>
                        </div>
                    ))}
                    <input 
                        type="text" 
                        placeholder="Add new task..."
                        onKeyDown={(e) => {
                            if (e.key === 'Enter' && e.target.value.trim()) {
                                const newTask = { id: Date.now(), text: e.target.value.trim(), completed: false };
                                const newTasks = [...sharedTasks, newTask];
                                setSharedTasks(newTasks);
                                // sendTask(newTasks)
                                e.target.value = '';
                            }
                        }}
                        className="w-full bg-fc-sidebar text-white text-sm px-2 py-1 rounded-lg border border-gray-700"
                    />
                </div>
                
                {/* Shared Clock/Countdown Timer (Feature 38) */}
                <div className="text-xs text-fc-system uppercase mb-2 font-semibold tracking-wider mt-6 border-t border-gray-700 pt-4">Room Timer (Feature 38)</div>
                <div className="text-3xl font-mono text-fc-accent text-center bg-fc-input p-2 rounded-xl border border-gray-600">
                    <i className="fas fa-clock mr-2"></i> 00:00:00 (Simulated)
                </div>

              </div>
              <div className="p-4 border-t border-gray-700">
                <button onClick={onLeave} className="text-fc-system hover:text-red-500 transition flex items-center gap-2 font-medium"><i className="fas fa-sign-out-alt"></i> Disconnect Session</button>
              </div>
            </div>

            {/* Main Chat Area */}
            <div className="flex-1 flex flex-col min-w-0">
              {/* Header */}
              <div className={`h-14 border-b border-gray-700 flex items-center justify-between px-4 bg-${currentTheme.sidebar}`}>
                <div className="flex items-center gap-2">
                  <button onClick={onLeave} className="lg:hidden text-fc-system hover:text-fc-primary"><i className="fas fa-arrow-left"></i></button>
                  <span className={`font-bold text-${currentTheme.text} text-lg`}>#{roomCode}</span>
                </div>
                <div className="flex items-center gap-4">
                   {settings.virtualPet && ( // Feature 45
                       <div className="text-xl" title={`Virtual Pet Mood: ${sentiment > 0.1 ? 'Happy' : sentiment < -0.1 ? 'Sad' : 'Neutral'}`}>
                           {sentiment > 0.1 ? 'ðŸ˜„' : sentiment < -0.1 ? 'ðŸ™' : 'ðŸ˜'}
                       </div>
                   )}
                   <span className="text-xs text-fc-system hidden sm:inline">STATUS: Secure P2P</span>
                   <div className={`w-3 h-3 rounded-full ${Object.keys(peers).length > 0 ? 'bg-fc-accent shadow-md shadow-fc-accent/50' : 'bg-fc-primary animate-pulse'}`}></div>
                </div>
              </div>

              {/* Global Fact Stream (Feature 46) */}
              {settings.factStream && (
                  <div className={`bg-fc-sidebar text-xs text-center p-1 italic border-b border-gray-700 text-fc-system overflow-hidden whitespace-nowrap`}>
                      <span className="inline-block animate-[pulse_5s_ease-in-out_infinite] px-4">
                          <i className="fas fa-lightbulb text-yellow-500 mr-2"></i>
                          {globalFact}
                      </span>
                  </div>
              )}

              {/* Messages List */}
              <div className={chatClasses} ref={scrollRef}>
                {messages.length === 0 && (
                   <div className="text-center text-fc-system mt-10">Start a feature-rich conversation.</div>
                )}
                {messages.map((msg) => {
                  const isMe = msg.isMe;
                  const isSystem = msg.isSystem;
                  
                  if (isSystem) {
                    return <div key={msg.id} className="w-full text-center text-xs text-fc-system italic my-3 animate-fade-in font-mono border-y border-gray-700 py-1">{msg.text}</div>;
                  }
                  
                  const isSelfDestruct = msg.selfDestructTimer > 0;
                  const displayTime = formatTime(msg.timestamp);

                  // Feature 13: Local Encryption Toggle
                  const [isEncryptedHover, setIsEncryptedHover] = useState(false);
                  const displayContent = settings.localEncryption && !isEncryptedHover && !isMe 
                                         ? '*** [Encrypted Content] ***' 
                                         : msg.text;
                                         
                  // Feature 36: Code Snippet Highlighting (basic detection)
                  const isCode = msg.text.startsWith('```') && msg.text.endsWith('```');

                  return (
                    <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} animate-bouncing-bubble group ${chatFontClass}`}>
                      <div className={`max-w-[85%] md:max-w-[60%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                        {/* Sender Name (Feature 26: Nickname Color Gradient - Simulated) */}
                        {!isMe && <div className="text-xs text-fc-system ml-2 mb-1 font-semibold" style={{ color: msg.sender === 'AI Assistant' ? currentTheme.accent : undefined }}>{msg.sender}</div>}
                        
                        {/* Message Bubble */}
                        <div className={`rounded-2xl break-words text-sm relative group`}
                             title={`${isSelfDestruct ? `Self-Destructs in ${Math.ceil((msg.timestamp + msg.selfDestructTimer - Date.now()) / 1000)}s` : ''} Sent at ${displayTime}`}
                             onMouseEnter={() => setIsEncryptedHover(true)}
                             onMouseLeave={() => setIsEncryptedHover(false)}
                             >
                            
                            <div className={`inline-block px-4 py-2 rounded-2xl transition duration-100 shadow-md ${
                                isMe ? `bg-[${settings.bubbleColor}] text-white rounded-br-sm shadow-fc-primary/30` : 'bg-fc-bubble text-white rounded-bl-sm shadow-black/20'
                            } ${isCode ? 'p-1' : ''}`}
                            style={isMe ? { backgroundColor: settings.bubbleColor } : {}}>
                                {isCode ? ( // Feature 36
                                    <pre className="overflow-auto bg-black bg-opacity-30 p-2 rounded text-xs font-mono">
                                        {displayContent.replace(/```/g, '')}
                                    </pre>
                                ) : (
                                    displayContent
                                )}
                            </div>
                            
                            {/* Reactions (Feature 24) */}
                            {msg.reactions && msg.reactions.length > 0 && (
                                <div className={`absolute -bottom-2 ${isMe ? 'left-0' : 'right-0'} bg-fc-sidebar px-2 py-0.5 rounded-full text-xs shadow-lg border border-gray-700 flex gap-1 z-10`}>
                                    {msg.reactions.map((r, i) => (
                                        <span key={i} title={`${r.sender} reacted with ${r.emoji}`}>{r.emoji}</span>
                                    ))}
                                </div>
                            )}

                            {/* Context Menu (Features 23, 10, 39, 40) */}
                            <div className={`absolute top-0 flex gap-1 transition-opacity duration-300 opacity-0 group-hover:opacity-100 ${isMe ? '-left-20' : '-right-20'}`}>
                                {/* Quote/Reply */}
                                <button title="Quote/Reply (Feature 23)" className="text-xs text-fc-system hover:text-fc-accent p-1 transition"><i className="fas fa-reply"></i></button>
                                {/* Fact Check */}
                                <button title="Fact Check (Feature 10)" className="text-xs text-fc-system hover:text-yellow-500 p-1 transition"><i className="fas fa-check-circle"></i></button>
                                {/* Quick Search */}
                                <button title="Quick Search (Feature 39)" className="text-xs text-fc-system hover:text-fc-primary p-1 transition"><i className="fas fa-search"></i></button>
                                {/* Copy Button */}
                                <button onClick={() => copyMessageText(msg.text)} title="Copy Text" className="text-xs text-fc-system hover:text-fc-accent p-1 transition"><i className="fas fa-copy"></i></button>
                                {/* Delete Button */}
                                {isMe && (
                                    <button onClick={() => deleteMessage(msg.id)} title="Delete Message (Local Only)" className="text-xs text-red-500 hover:text-red-400 p-1 transition"><i className="fas fa-trash-alt"></i></button>
                                )}
                            </div>
                        </div>
                        {isMe && <div className="text-xs text-fc-accent mt-1"><i className="fas fa-check-double"></i></div>} {/* Feature 18: Receipt Confirmation (Simulated) */}
                      </div>
                    </div>
                  );
                })}
                
                {/* Typing Indicator */}
                {isTypingActive && (
                    <div className="flex justify-start pt-2 animate-fade-in">
                        <div className="max-w-[60%] bg-fc-input text-fc-system rounded-2xl px-4 py-2 text-sm italic shadow-inner">
                            <i className="fas fa-circle-notch animate-spin mr-1 text-fc-accent"></i> {typingNames} {Object.keys(typingUsers).length > 1 ? 'are' : 'is'} typing...
                        </div>
                    </div>
                )}
              </div>

              {/* Input Area */}
              <div className={`p-4 bg-${currentTheme.bg} border-t border-gray-700 relative shadow-inner shadow-black/30`}>
                 {/* Emoji Picker Modal */}
                 {showEmojiPicker && (
                    <div className={`absolute bottom-full mb-3 bg-${currentTheme.sidebar} p-4 rounded-xl shadow-2xl border border-gray-700 w-full max-w-sm right-0 left-0 mx-auto`}>
                        <div className="emoji-picker-grid">
                            {EMOJIS.map(emoji => (
                                <button key={emoji} className={`text-2xl hover:bg-fc-input rounded-lg p-1 transition transform hover:scale-110`} onClick={() => handleEmojiClick(emoji)}>{emoji}</button>
                            ))}
                            {/* Feature 24: Extra Reactions */}
                            {['ðŸ¥³', 'ðŸ¤¯', 'ðŸ˜­', 'ðŸ’°', 'ðŸ”‘'].map(emoji => (
                                <button key={emoji} className={`text-2xl hover:bg-fc-input rounded-lg p-1 transition transform hover:scale-110`} onClick={() => sendReaction('last-message-id-simulated', emoji)} title="Send as Reaction">{emoji}</button>
                            ))}
                        </div>
                    </div>
                 )}
                
                <form onSubmit={handleSendMessage} className="flex flex-col gap-2 max-w-4xl mx-auto">
                   
                   {/* AI/Utility & Self-Destruct Tools Bar (Features 1, 3, 52, 11, 35) */}
                    <div className="flex flex-wrap items-center gap-4 text-xs">
                       <button type="button" onClick={() => handleAITool('translate')} disabled={aiLoading || !input.trim()} className="text-fc-accent hover:text-fc-primary flex items-center gap-1 transition disabled:opacity-50 font-medium">
                         <i className={`fas fa-language ${aiLoading ? 'animate-spin' : ''}`}></i> Translate
                       </button>
                       <button type="button" onClick={() => handleAITool('summarize')} disabled={aiLoading || messages.length === 0} className="text-fc-accent hover:text-fc-primary flex items-center gap-1 transition disabled:opacity-50 font-medium">
                         <i className={`fas fa-microchip ${aiLoading ? 'animate-spin' : ''}`}></i> Summary
                       </button>
                       
                       <select 
                            value={selectedTone}
                            onChange={(e) => setSelectedTone(e.target.value)}
                            disabled={aiLoading}
                            className={`bg-fc-input border border-gray-600 rounded-lg p-1 text-white text-xs disabled:opacity-50`}
                        >
                           <option value="standard">Standard Tone</option>
                           <option value="formal">Formal</option>
                           <option value="sarcastic">Sarcastic (Feature 1)</option>
                           <option value="pirate">Pirate (Irrelevant)</option>
                       </select>
                       <button type="button" onClick={() => handleAITool('tone')} disabled={aiLoading || !input.trim()} className="text-fc-accent hover:text-fc-primary transition disabled:opacity-50">
                         <i className="fas fa-brush"></i> Adjust Tone
                       </button>
                       <button type="button" onClick={() => handleAITool('grammar')} disabled={aiLoading || !input.trim()} className="text-fc-accent hover:text-fc-primary transition disabled:opacity-50">
                         <i className="fas fa-spell-check"></i> Fix Grammar (F2)
                       </button>
                       
                       <button type="button" onClick={() => handleAITool('haiku')} disabled={aiLoading || !input.trim()} className="text-fc-accent hover:text-fc-primary transition disabled:opacity-50">
                         <i className="fas fa-feather"></i> Haiku (F52)
                       </button>

                       <button type="button" onClick={calculateInline} disabled={aiLoading || !input.trim()} className="text-fc-accent hover:text-fc-primary transition disabled:opacity-50">
                         <i className="fas fa-calculator"></i> = Calc (F35)
                       </button>

                       {/* Self-Destruct Timer */}
                       <div className="flex items-center gap-1 ml-auto">
                           <i className="fas fa-bomb text-red-500"></i>
                           <select 
                                value={selfDestructTime}
                                onChange={(e) => setSelfDestructTime(parseInt(e.target.value))}
                                disabled={aiLoading}
                                className={`bg-fc-input border border-gray-600 rounded-lg p-1 text-white text-xs disabled:opacity-50`}
                            >
                               <option value={0}>No Timer</option>
                               <option value={5000}>5s</option>
                               <option value={15000}>15s (F11)</option>
                               <option value={60000}>1m</option>
                           </select>
                       </div>

                       {aiLoading && <span className="text-xs text-fc-accent font-semibold">AI is processing... (Feature 44 Time Warp Active)</span>}
                    </div>

                  <div className={`flex items-center gap-2 bg-${currentTheme.sidebar} rounded-2xl p-2 border border-gray-700 focus-within:ring-2 focus-within:ring-fc-accent/50 shadow-lg shadow-black/20`}>
                    <button 
                        type="button" 
                        onClick={() => setShowEmojiPicker(prev => !prev)} 
                        className="text-xl text-fc-system hover:text-fc-accent p-2 rounded-full transition"
                        title="Open Emoji Selector & Reactions"
                    >
                        <i className="fas fa-face-smile"></i>
                    </button>
                    <input 
                      className="flex-1 bg-transparent text-white px-3 py-2 outline-none placeholder-gray-500" 
                      placeholder="Send message..." 
                      value={input} 
                      onChange={handleTyping}
                      autoFocus
                    />
                    <button type="submit" disabled={!input.trim() || aiLoading} className="bg-fc-primary hover:bg-blue-600 text-white p-3 rounded-xl w-12 h-12 flex items-center justify-center transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-fc-primary/40">
                      <i className="fas fa-paper-plane text-lg"></i>
                    </button>
                  </div>
                </form>
                
                {/* Simulated Collaboration / Irrelevant Buttons */}
                <div className="flex flex-wrap justify-between gap-2 mt-2 pt-2 border-t border-gray-700">
                    <span className="text-xs text-fc-system">Collaboration Tools:</span>
                    <button title="Shared Whiteboard (F29)" className="text-xs text-fc-system hover:text-fc-accent"><i className="fas fa-pencil-ruler"></i> Whiteboard</button>
                    <button title="Ephemeral Image Sharing (F12)" className="text-xs text-fc-system hover:text-fc-accent"><i className="fas fa-camera"></i> Image (View Once)</button>
                    <button title="Poll Creation (F31)" className="text-xs text-fc-system hover:text-fc-accent"><i className="fas fa-poll"></i> New Poll</button>
                    <button title="Turing Test Challenge (F47)" className="text-xs text-red-500 hover:text-red-400"><i className="fas fa-robot"></i> Turing Test</button>
                    <button title="Code/Regex Generator (F5)" className="text-xs text-fc-accent hover:text-fc-primary"><i className="fas fa-code"></i> AI Code</button>
                    <button title="Screen Share Request (F33)" className="text-xs text-fc-primary hover:text-fc-accent"><i className="fas fa-desktop"></i> Screen Share</button>
                    <button title="Export Chat Log (F40)" className="text-xs text-fc-system hover:text-fc-accent"><i className="fas fa-file-export"></i> Export Log</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- 4. MAIN APP ---
      const App = () => {
        const [view, setView] = useState("landing");
        const [userData, setUserData] = useState({ name: "", room: "" });
        const [initialRoom, setInitialRoom] = useState("");
        
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          const roomParam = params.get("room");
          if (roomParam) {
            setInitialRoom(roomParam);
          }
        }, []);

        const handleJoin = (name, room) => {
          setUserData({ name, room });
          setView("chat");
          
          const url = new URL(window.location.href);
          url.searchParams.set("room", room);
          window.history.pushState({}, "", url);
        };
        
        const handleLeave = () => {
          setView("landing");
          setUserData({ name: "", room: "" });
          const url = new URL(window.location.href);
          url.searchParams.delete("room");
          window.history.pushState({}, "", url);
        };

        return (
          <React.StrictMode>
            {view === "landing" ? (
              <LandingPage onJoin={handleJoin} initialRoom={initialRoom} />
            ) : (
              <ChatRoom 
                nickname={userData.name} 
                roomCode={userData.room} 
                onLeave={handleLeave} 
              />
            )}
          </React.StrictMode>
        );
      };

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
