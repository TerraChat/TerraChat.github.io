<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TerraChat - P2P</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.17.0",
        "trystero/torrent": "https://esm.sh/trystero@0.20.0/torrent"
      }
    }
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              chat: { bg: '#0f172a', sidebar: '#1e293b', input: '#334155', bubble: '#334155', bubbleUser: '#4f46e5' }
            },
            animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
            keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; }
      .custom-scroll::-webkit-scrollbar { width: 6px; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
  </head>
  <body>
    <div id="root" class="h-screen w-full flex flex-col"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from "react";
      import { createRoot } from "react-dom/client";
      import { GoogleGenerativeAI } from "@google/generative-ai";
      import { joinRoom } from "trystero/torrent";

      // --- 1. CONFIGURATION ---
      // No Database Config needed! Using P2P.
      const GEMINI_API_KEY = "AIzaSyCO3vw58VDZyHaIQ9yOMni5fepndQ29zJ4"; 
      const APP_ID = 'terrachat-live-v1'; // Keeps rooms separate from other apps

      // --- 2. SERVICES ---
      const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
      const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // --- 3. COMPONENTS ---

      // A. Landing Page
      const LandingPage = ({ onJoin }) => {
        const [name, setName] = useState("");
        const [room, setRoom] = useState("");

        return (
          <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-slate-900 to-indigo-950 p-4">
            <div className="w-full max-w-md bg-chat-sidebar p-8 rounded-2xl shadow-2xl border border-slate-700">
              <div className="text-center mb-8">
                <i className="fas fa-network-wired text-4xl text-indigo-500 mb-4"></i>
                <h1 className="text-3xl font-bold text-white">TerraChat P2P</h1>
                <p className="text-slate-400">Serverless. Real People. No Setup.</p>
              </div>
              <form onSubmit={(e) => { e.preventDefault(); if(name && room) onJoin(name, room); }} className="space-y-4">
                <input 
                  className="w-full bg-chat-input text-white border border-slate-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-indigo-500 outline-none" 
                  placeholder="Your Nickname" 
                  value={name} onChange={e => setName(e.target.value)} required 
                />
                <div className="flex gap-2">
                  <input 
                    className="w-full bg-chat-input text-white border border-slate-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-indigo-500 outline-none uppercase" 
                    placeholder="Room Code (e.g. LOBBY)" 
                    value={room} onChange={e => setRoom(e.target.value.toUpperCase())} required 
                  />
                </div>
                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95">
                  Join P2P Network
                </button>
              </form>
            </div>
          </div>
        );
      };

      // B. Chat Room (P2P Logic)
      const ChatRoom = ({ nickname, roomCode, onLeave }) => {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [peers, setPeers] = useState({}); // Map peerId -> name
        const [aiLoading, setAiLoading] = useState(false);
        const [status, setStatus] = useState("Connecting to peers...");
        
        const roomRef = useRef(null);
        const scrollRef = useRef(null);

        // --- P2P Connection Setup ---
        useEffect(() => {
          // 1. Join the "Room"
          const config = { appId: APP_ID };
          const room = joinRoom(config, roomCode);
          roomRef.current = room;

          // 2. Define Actions
          const [sendChat, getChat] = room.makeAction('chat');
          const [sendName, getName] = room.makeAction('name');

          // 3. Handle Incoming Messages
          getChat((data, peerId) => {
            setMessages(prev => [...prev, { ...data, isMe: false, timestamp: Date.now() }]);
          });

          // 4. Handle Name Syncing (Since P2P doesn't have profiles)
          getName((name, peerId) => {
            setPeers(prev => ({ ...prev, [peerId]: name }));
          });

          // 5. Handle Peer Events
          room.onPeerJoin(peerId => {
            console.log("Peer joined:", peerId);
            setStatus("Connected");
            // Send my name to the new person
            sendName(nickname);
          });

          room.onPeerLeave(peerId => {
            console.log("Peer left:", peerId);
            setPeers(prev => {
              const newPeers = { ...prev };
              delete newPeers[peerId];
              return newPeers;
            });
          });

          // 6. Broadcast my name immediately to anyone already there
          sendName(nickname);

          // Add Welcome Message
          setMessages([{ 
            id: 'sys-welcome', 
            text: `Joined channel "${roomCode}". Waiting for others...`, 
            sender: 'System', 
            isMe: false, 
            isSystem: true 
          }]);

          return () => {
            room.leave();
          };
        }, [roomCode, nickname]);

        // Auto-scroll
        useEffect(() => {
          if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }, [messages]);

        const handleSendMessage = (e) => {
          e.preventDefault();
          if (!input.trim() || !roomRef.current) return;

          const msgData = {
            id: Math.random().toString(36),
            text: input,
            sender: nickname,
          };

          // Send to peers
          const [sendChat] = roomRef.current.makeAction('chat');
          sendChat(msgData);

          // Add to local view
          setMessages(prev => [...prev, { ...msgData, isMe: true, timestamp: Date.now() }]);
          setInput("");
        };

        const fixGrammar = async () => {
          if (!input.trim()) return;
          setAiLoading(true);
          try {
            const result = await model.generateContent(`Fix the grammar and make this text sound natural, return ONLY the fixed text: "${input}"`);
            setInput(result.response.text().trim());
          } catch (e) {
            console.error(e);
            alert("AI Tool Error");
          } finally {
            setAiLoading(false);
          }
        };

        return (
          <div className="flex h-screen bg-chat-bg">
            {/* Sidebar */}
            <div className="hidden md:flex w-64 bg-chat-sidebar flex-col border-r border-slate-700">
              <div className="p-4 border-b border-slate-700 font-bold text-lg text-indigo-400">TerraChat P2P</div>
              <div className="p-4 flex-1">
                <div className="text-xs text-slate-500 uppercase mb-2">Room Code</div>
                <div className="text-xl font-mono text-white mb-6">#{roomCode}</div>
                
                <div className="text-xs text-slate-500 uppercase mb-2">Peers Online ({Object.keys(peers).length})</div>
                <ul className="space-y-2 mb-6">
                  {Object.values(peers).map((p, i) => (
                    <li key={i} className="text-sm text-slate-300 flex items-center gap-2">
                       <span className="w-2 h-2 bg-green-500 rounded-full"></span> {p}
                    </li>
                  ))}
                  {Object.keys(peers).length === 0 && <li className="text-sm text-slate-600 italic">No one else here...</li>}
                </ul>

                <div className="text-xs text-slate-500 uppercase mb-2">You</div>
                <div className="text-sm text-slate-300 truncate font-bold">{nickname}</div>
              </div>
              <div className="p-4 border-t border-slate-700">
                <button onClick={onLeave} className="text-slate-400 hover:text-white flex items-center gap-2"><i className="fas fa-sign-out-alt"></i> Leave</button>
              </div>
            </div>

            {/* Main Chat */}
            <div className="flex-1 flex flex-col min-w-0">
              {/* Header */}
              <div className="h-14 border-b border-slate-700 flex items-center justify-between px-4 bg-chat-sidebar md:bg-transparent">
                <div className="flex items-center gap-2">
                  <button onClick={onLeave} className="md:hidden text-slate-400"><i className="fas fa-arrow-left"></i></button>
                  <span className="font-bold text-white">#{roomCode}</span>
                </div>
                <div className="flex items-center gap-2">
                   <div className={`w-2 h-2 rounded-full ${Object.keys(peers).length > 0 ? 'bg-green-500' : 'bg-yellow-500 animate-pulse'}`}></div>
                   <span className="text-xs text-slate-500 hidden sm:inline">{Object.keys(peers).length > 0 ? 'Active Connection' : status}</span>
                </div>
              </div>

              {/* Messages List */}
              <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll" ref={scrollRef}>
                {messages.map((msg) => (
                  <div key={msg.id} className={`flex ${msg.isMe ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                     {msg.isSystem ? (
                        <div className="w-full text-center text-xs text-slate-500 my-2">{msg.text}</div>
                     ) : (
                        <div className={`max-w-[80%] md:max-w-[60%]`}>
                          {!msg.isMe && <div className="text-xs text-slate-400 ml-1 mb-1">{msg.sender}</div>}
                          <div className={`px-4 py-2 rounded-2xl break-words text-sm ${msg.isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-700 text-slate-200 rounded-bl-none'}`}>
                            {msg.text}
                          </div>
                        </div>
                     )}
                  </div>
                ))}
              </div>

              {/* Input Area */}
              <div className="p-4 bg-chat-bg border-t border-slate-700">
                <form onSubmit={handleSendMessage} className="flex flex-col gap-2 max-w-4xl mx-auto">
                   {input.trim() && (
                    <div className="flex gap-2">
                       <button type="button" onClick={fixGrammar} disabled={aiLoading} className="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1">
                         <i className={`fas fa-magic ${aiLoading ? 'animate-spin' : ''}`}></i> AI Fix
                       </button>
                    </div>
                  )}
                  <div className="flex items-center gap-2 bg-chat-input rounded-xl p-2 border border-slate-600 focus-within:ring-2 focus-within:ring-indigo-500/50">
                    <input 
                      className="flex-1 bg-transparent text-white px-3 py-2 outline-none placeholder-slate-400" 
                      placeholder="Type a message..." 
                      value={input} 
                      onChange={e => setInput(e.target.value)}
                      autoFocus
                    />
                    <button type="submit" disabled={!input.trim()} className="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg w-10 h-10 flex items-center justify-center transition disabled:opacity-50">
                      <i className="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        );
      };

      // --- 4. MAIN APP ---
      const App = () => {
        const [view, setView] = useState("landing");
        const [userData, setUserData] = useState({ name: "", room: "" });

        const handleJoin = (name, room) => {
          setUserData({ name, room });
          setView("chat");
        };

        return (
          <React.StrictMode>
            {view === "landing" ? (
              <LandingPage onJoin={handleJoin} />
            ) : (
              <ChatRoom 
                nickname={userData.name} 
                roomCode={userData.room} 
                onLeave={() => setView("landing")} 
              />
            )}
          </React.StrictMode>
        );
      };

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
